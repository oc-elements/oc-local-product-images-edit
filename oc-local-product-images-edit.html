<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../oc-product-api/oc-product-api.html">
<link rel="import" href="../oc-product-image-edit/oc-product-image-edit.html">

<!--
`oc-local-product-images-edit`
Element to manage local product images on the Ordercloud platform

@demo demo/index.html
-->

<dom-module id="oc-local-product-images-edit">
  <template>
    <oc-product-api id="prodApi"></oc-product-api>

    <oc-product-image-edit images="[[_images]]" ></oc-product-image-edit>
  </template>

  <script>
    Polymer({

      is: 'oc-local-product-images-edit',

      properties: {
        organisationId: Number,
        productId : Number,
        product: Object,
        loading: {
          type: Boolean,
          notify: true
        }
      },

      listeners: {
        'delete' : '_deleteImage',
        'default' : '_setDefaultImage',
      },

      refresh: function(){
        this._getProductImages()
      },

      _getProductImages: function(productId) {
        var productId = productId || this.productId;

        this.$.prodApi.getProductImages(productId)
                .then(function(request){
                  console.log(request.response);
                  this._images = request.response.results;
                }.bind(this))
                .catch(this.fire.bind(this, 'options_error', 'Could not load product images'))
                .finally(this.set.bind(this, 'loading', false));
      },

      _getImageName : function(imageUrl){
        return imageUrl.split('/').splice(-1,1)[0];
      },

      _deleteImage : function(e){
        this.loading = true;

        this.$.prodApi.deleteProductImage(this.productId, this._getImageName(e.detail.name))
                .then(function(request){
                  this._getProductImages()
                }.bind(this))
                .catch(this.fire.bind(this, 'options_error', 'Could not delete image'))
                .finally(this.set.bind(this, 'loading', false));
      },

      _setDefaultImage : function(e){
        this.loading = true;
        this.$.prodApi.setDefaultImage(this.productId, this._getImageName(e.detail.name))
                .then(function(request){
                  this._getProductImages()
                }.bind(this))
                .catch(this.fire.bind(this, 'options_error', 'Could not set default image'))
                .finally(this.set.bind(this, 'loading', false));
      }

    });
  </script>
</dom-module>
